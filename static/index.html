<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streaming ZIP Download Test</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: #38bdf8;
    }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }
    textarea {
      width: 100%;
      height: 150px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.875rem;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: #38bdf8;
    }
    button {
      background: #38bdf8;
      color: #0f172a;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.2s;
    }
    button:hover {
      background: #7dd3fc;
    }
    button:disabled {
      background: #475569;
      cursor: not-allowed;
    }
    .progress-container {
      margin-top: 1.5rem;
    }
    .progress-bar {
      height: 8px;
      background: #334155;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #818cf8);
      width: 0%;
      transition: width 0.1s;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat {
      background: #0f172a;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #38bdf8;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }
    .log {
      background: #0f172a;
      border-radius: 8px;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      margin-top: 1rem;
    }
    .log-entry {
      padding: 0.25rem 0;
      border-bottom: 1px solid #1e293b;
    }
    .log-entry.success { color: #4ade80; }
    .log-entry.error { color: #f87171; }
    .log-entry.info { color: #38bdf8; }
    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 0.5rem;
    }
    .status.idle { background: #334155; }
    .status.downloading { background: #0369a1; animation: pulse 1s infinite; }
    .status.complete { background: #166534; }
    .status.error { background: #991b1b; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Streaming ZIP Download Test <span class="status idle" id="status">Idle</span></h1>
    
    <div class="card">
      <label>File URLs (one per line)</label>
      <textarea id="urls" placeholder="http://localhost:4566/my-bucket/file1.pdf
http://localhost:4566/my-bucket/file2.pdf
http://localhost:4566/my-bucket/file3.pdf"></textarea>
      <button id="downloadBtn" onclick="startDownload()">‚¨áÔ∏è Download (Browser Native)</button>
      <button onclick="startDownloadWithLog()" style="background: #6366f1; margin-left: 0.5rem;">üîç Download + Log Chunks</button>
    </div>

    <div class="card">
      <label>Progress</label>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="received">0 B</div>
          <div class="stat-label">Received</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="chunks">0</div>
          <div class="stat-label">Chunks</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="speed">0 KB/s</div>
          <div class="stat-label">Speed</div>
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    let startTime;
    let totalReceived = 0;
    let chunkCount = 0;

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(status) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${status}`;
      statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }

    function updateStats() {
      document.getElementById('received').textContent = formatBytes(totalReceived);
      document.getElementById('chunks').textContent = chunkCount;
      
      const elapsed = (Date.now() - startTime) / 1000;
      const speed = totalReceived / elapsed;
      document.getElementById('speed').textContent = formatBytes(speed) + '/s';
    }

    function startDownload() {
      const urlsText = document.getElementById('urls').value.trim();
      if (!urlsText) {
        alert('Please enter at least one URL');
        return;
      }

      const urls = urlsText.split('\n').map(u => u.trim()).filter(u => u);

      console.log('urls', urls)
      
      setStatus('downloading');
      log(`Triggering browser download for ${urls.length} file(s)...`, 'info');
      log('Check your browser download progress!', 'success');

      // Create hidden form and submit - triggers native browser download
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'http://localhost:8080/api/download';
      form.style.display = 'none';

      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'json';
      input.value = JSON.stringify({ urls });
      form.appendChild(input);

      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      setTimeout(() => setStatus('idle'), 2000);
    }

    // Alternative: Monitor with fetch (for logging only)
    async function startDownloadWithLog() {
      const urlsText = document.getElementById('urls').value.trim();
      if (!urlsText) {
        alert('Please enter at least one URL');
        return;
      }

      const urls = urlsText.split('\n').map(u => u.trim()).filter(u => u);
      
      // Reset
      totalReceived = 0;
      chunkCount = 0;
      startTime = Date.now();
      document.getElementById('log').innerHTML = '';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('downloadBtn').disabled = true;
      setStatus('downloading');

      log(`Starting download of ${urls.length} file(s)...`, 'info');

      try {
        const response = await fetch('http://localhost:8080/api/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        log(`Response received, Transfer-Encoding: ${response.headers.get('Transfer-Encoding') || 'chunked'}`, 'success');

        const reader = response.body.getReader();
        const chunks = [];

        while (true) {
          const { done, value } = await reader.read();
          
          if (done) {
            log('Stream complete!', 'success');
            break;
          }

          chunks.push(value);
          totalReceived += value.length;
          chunkCount++;
          
          log(`Chunk #${chunkCount}: +${formatBytes(value.length)} (Total: ${formatBytes(totalReceived)})`, 'info');
          updateStats();
          
          // Animate progress (indeterminate since we don't know total size)
          const progress = Math.min(95, (chunkCount * 5) % 100);
          document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // Combine chunks and download
        const blob = new Blob(chunks, { type: 'application/zip' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'download.zip';
        a.click();
        URL.revokeObjectURL(url);

        document.getElementById('progressFill').style.width = '100%';
        setStatus('complete');
        log(`Download complete! Total: ${formatBytes(totalReceived)} in ${chunkCount} chunks`, 'success');

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        setStatus('error');
      } finally {
        document.getElementById('downloadBtn').disabled = false;
      }
    }
  </script>
</body>
</html>
